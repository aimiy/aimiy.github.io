---
layout: post
title:  网站性能优化
date:   2017-09-26 11:00:00 +0800
categories: notes
tag: 优化
---

* content
{:toc}


# 关键渲染路径(critical rendering path)
关键渲染路径是浏览器所经历的一系列步骤，从而将HTML，css，js，转换为屏幕上呈现的像素内容。如果我们能优化关键呈现路径，那么网站的性能就会得到很好的优化。



```
graph TB
DOM-->CSSOM
DOM-->JavaScript
JavaScript-->CSSOM
CSSOM-->RenderTree
RenderTree-->Layout
Layout-->Paint
```

当在浏览器窗口输入url的时候，浏览器就会向服务器发送一个请求，请求到的是HTML源文件，浏览器遵守定义完善的步骤，将文件显示在屏幕上。

首先就是从HTML和构建Dom开始。
## HTML转换为DOM
HTML包含了一组规则，规定我们应该如何处理接收数据。

```
graph TB
Characters-->Token
Token-->Nodes
Nodes-->Dom
```
每当遇到<>的标记（characters），浏览器都会发出一个令牌（token），分为starttag与endtag，整个过程都由令牌生成器来完成，同时领一个流程正在消耗这些令牌，并将他们转换为节点（nodes）对象。
每消耗一个令牌就就生成一个节点对象，令牌的start与end之间的包含关系，就形成了父节点子节点的关系，当所有的令牌消耗完成后，就形成了文档对象模型，简称DOM。

Dom是个树结构，表明了HTML的内容和属性，以及各个节点的所有关系，因此也叫Domtree。

domtree的对象包含了标签所有的属性，不单纯只是一个结构关系。

dom会捕获页面内容，但是我们还需要知道如何展示页面本身，因此就需要构建CSS对象模型。


## 将CSS转换为CSSOM
```
graph TB
Characters-->Tokens
Tokens-->Nodes
Nodes-->CSSom
```
收到CSS后，浏览器首先要做的也是识别令牌，只是这个时候就不是<>,对于如何识别出一套有效的令牌，CSS有自己的规则，参照CSS规范链接。

[构建对象模型](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/constructing-the-object-model#css-object-model-cssom)
[阻塞渲染的CSS](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css)

同样的，解析器会将令牌转换成节点，形成具有父子节点关系的CSS对象模型。
同时，子节点继承父节点的样式规则，这就是层叠规则和层叠样式表。

与Dom的不同就是CSS规则会向下层叠，同时，也不能像html一样使用部分dom树来构建网页，因为后续的CSS样式可能会更改前面已经加载的样式规则，因此必须在所有的CSS内容加载完成后，再使用css渲染页面。

再CSS对象模型里，更加具体的标记实际上要求浏览器处理更多工作，成本更高，因为它需要遍历Dom树中的更多节点，但选择匹配器往往不会太影响性能，因此需要先衡量再优化。

## 渲染树

Dom与CSSom获得以后，就由这两个部分形成，渲染树（rendertree）来构建屏幕的显示内容。

要构建渲染树，从DOM的根部开始，寻找段落节点，根据此寻找有无相符的CSS规则，若有便将段落节点复制到渲染树里，然后向下寻找节点。渲染树仅捕获可见内容，会削减掉其他不可见的内容，因此若遇到body以外或者无样式，或者displaynone，则不必向下寻找该节点的子节点，毕竟CSS样式是层叠的。然后寻找别的节点，渲染树会同时捕获内容和样式，构建渲染树。

## 布局
有了渲染树，我们还需要布局来控制显示的内容，因为，当浏览器的视窗发生变化时，我们的布局都会发生变化，变化后会重新按照样式显示内容。
当样式更改时，布局也会发生变化，会重新形成布局。

